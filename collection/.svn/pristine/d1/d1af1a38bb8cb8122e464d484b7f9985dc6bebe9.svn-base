<template>
<div>
  <div v-if="!allotPage">
    <div class="content-body">
      <!-- 顶部，包括标题，操作按钮-->
      <div class="bd-top">
        <div class="md clearfix">
          <!-- 1、左边标题 -->
          <div class="md-left">
            <h5>案件管理</h5>
          </div>
          <!-- 2、右边操作按钮 -->
          <div class="md-right">
            <el-button size="mini" type="primary" @click.native.prevent="allotCase">人工分案</el-button>
            <el-button size="mini" type="primary" @click.native.prevent="invokCase">人工调案</el-button>
            <el-button size="mini" type="primary" @click.native.prevent="allotGroupCase">按搜索批量分案</el-button>
          </div>
        </div>
      </div>
      <div class="bd-main">
        <el-form ref="conditionForm" :model="conditionForm" :label-width="this.$util.LABEL_WIDTH" label-position="right" class="condition-form"
          size="mini">
          <div class="el-col fixed-width">
            <el-form-item label="案件号" prop="caseCode">
              <el-input v-model="conditionForm.caseCode" placeholder="请输入案件号" clearable></el-input>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="姓名" prop="borrowerName">
              <el-input v-model="conditionForm.borrowerName" placeholder="请输入姓名" clearable></el-input>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="身份证号" prop="borrowerIdnumber">
              <el-input v-model="conditionForm.borrowerIdnumber" placeholder="请输入身份证号" clearable></el-input>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="手机号" prop="borrowerPhone">
              <el-input v-model="conditionForm.borrowerPhone" placeholder="请输入手机号" clearable></el-input>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="贷款机构" prop="loanInstitution">
              <el-select placeholder="请选择贷款机构" v-model="conditionForm.loanInstitution" clearable>
                <el-option v-for="option in dropdownData.loanInstitution" :label="option.name" :value="option.code" :key="option.code"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="产品名称" prop="productName">
              <el-select placeholder="请选择产品名称" v-model="conditionForm.productName" clearable>
                <el-option v-for="option in dropdownData.productName" :label="option.name" :value="option.code" :key="option.code"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="批次号" prop="batchCode">
              <el-input v-model="conditionForm.batchCode" placeholder="请输入批次号" clearable></el-input>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="案件状态" prop="caseStatus">
              <el-select placeholder="请选择案件状态" v-model="conditionForm.caseStatus" clearable>
                <el-option v-for="option in dropdownData.caseStatus" :label="option.name" :value="option.code" :key="option.id"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="案件地区" prop="caseArea">
              <el-select placeholder="请选择案件地区" v-model="conditionForm.caseArea" clearable>
                <el-option v-for="option in dropdownData.caseArea" :label="option.name" :value="option.code" :key="option.code"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="户籍地" prop="registeredAddress">
              <el-select placeholder="请选择户籍地" v-model="conditionForm.registeredAddress" clearable>
                <el-option v-for="option in dropdownData.registeredAddress" :label="option.name" :value="option.code" :key="option.code"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="性别" prop="borrowerGender">
              <el-select placeholder="请选择性别" v-model="conditionForm.borrowerGender" clearable>
                <el-option v-for="option in dropdownData.gender" :label="option.name" :value="option.code" :key="option.id"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="年龄">
              <el-col :span="11">
                <el-form-item label="" prop="ageMin" ref="ageMin">
                  <el-input v-model="conditionForm.ageMin" placeholder="最小值" clearable></el-input>
                </el-form-item>
              </el-col>
              <el-col class="line" :span="2">-</el-col>
              <el-col :span="11">
                <el-form-item label="" prop="ageMax" ref="ageMax">
                  <el-input v-model="conditionForm.ageMax" placeholder="最大值" clearable></el-input>
                </el-form-item>
              </el-col>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="催收部门" prop="departmentId">
              <el-cascader :options="departments" change-on-select v-model="departmentIds" :props="departmentProps" @change="getDepartmentId"
                clearable>
              </el-cascader>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="催收员" prop="staffId">
              <el-select placeholder="请选择催收员" v-model="conditionForm.staffId" clearable>
                <el-option v-for="option in staffs" :label="option.name" :value="option.id" :key="option.id"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="跟进时间" prop="FollowDate">
              <el-date-picker type="daterange" v-model="conditionForm.FollowDate" format="yyyy/MM/dd" value-format="yyyy-MM-dd" range-separator="-"
                start-placeholder="开始日期" end-placeholder="结束日期" @change="followDate" clearable>
              </el-date-picker>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="催收状态" prop="collectionStatus">
              <el-select placeholder="请选择催收状态" v-model="conditionForm.collectionStatus" clearable>
                <el-option v-for="option in dropdownData.collectionStatus" :label="option.name" :value="option.code" :key="option.id"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="账龄" prop="receivableAge">
              <el-select placeholder="请选择账龄" v-model="conditionForm.receivableAge" clearable>
                <el-option v-for="option in dropdownData.receivableAge" :label="option.name" :value="option.code" :key="option.code"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="手别" prop="bacthTimes">
              <el-select placeholder="请选择手别" v-model="conditionForm.bacthTimes" clearable>
                <el-option v-for="option in dropdownData.bacthTimes" :label="option.name" :value="option.code" :key="option.code"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="逾期天数">
              <el-col :span="11">
                <el-form-item label="" prop="overdueDayMin" ref="overdueDayMin">
                  <el-input v-model="conditionForm.overdueDayMin" placeholder="最小值" clearable></el-input>
                </el-form-item>
              </el-col>
              <el-col class="line" :span="2">-</el-col>
              <el-col :span="11">
                <el-form-item label="" prop="overdueDayMax" ref="overdueDayMax">
                  <el-input v-model="conditionForm.overdueDayMax" placeholder="最大值" clearable></el-input>
                </el-form-item>
              </el-col>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="电话状态" prop="telStatus">
              <el-select placeholder="请选择电话状态" v-model="conditionForm.telStatus" clearable>
                <el-option v-for="option in dropdownData.telStatus" :label="option.name" :value="option.code" :key="option.id"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="委托时间" prop="CommitDate">
              <el-date-picker type="daterange" value-format="yyyy-MM-dd" format="yyyy/MM/dd" v-model="conditionForm.CommitDate" @change="commitDate"
                range-separator="-" start-placeholder="开始日期" end-placeholder="结束日期" clearable>
              </el-date-picker>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="退案时间" prop="LimitDate">
              <el-date-picker type="daterange" value-format="yyyy-MM-dd" format="yyyy/MM/dd" v-model="conditionForm.LimitDate" @change="limitDate"
                range-separator="-" start-placeholder="开始日期" end-placeholder="结束日期" clearable>
              </el-date-picker>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="委案金额">
              <el-col :span="11">
                <el-form-item label="" prop="commitMoneyMin" ref="commitMoneyMin">
                  <el-input v-model="conditionForm.commitMoneyMin" placeholder="最小值" clearable></el-input>
                </el-form-item>
              </el-col>
              <el-col class="line" :span="2">-</el-col>
              <el-col :span="11">
                <el-form-item label="" prop="commitMoneyMax" ref="commitMoneyMax">
                  <el-input v-model="conditionForm.commitMoneyMax" placeholder="最大值" clearable></el-input>
                </el-form-item>
              </el-col>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="分配状态" prop="allotStatus">
              <el-select placeholder="请选择分配状态" v-model="conditionForm.allotStatus" clearable>
                <el-option v-for="option in dropdownData.allotStatus" :label="option.name" :value="option.code" :key="option.id"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width form-btns">
            <el-button size="mini" @click="search" type="primary">搜索</el-button>
            <el-button size="mini" @click="reset">重置</el-button>
          </div>
        </el-form>
        <div style="clear:both">
          <!-- <el-table ref="multipleTable" height="500" :data="tb.data" tooltip-effect="dark" v-loading="loading" element-loading-text="拼命加载中"
            element-loading-spinner="el-icon-loading" @cell-click="redirect" @selection-change="handleSelectionChange">
            <el-table-column type="selection" fixed="left">
            </el-table-column>
            <el-table-column v-for="field in tb.fields" @click="redirect(field)" style="cursor:pointer" :align="field.align||'left'"
              :prop="field.key" :label="field.label" :width="field.width" :key="field.key" show-overflow-tooltip>
            </el-table-column>
          </el-table> -->
          <my-table :tb="tb"  :loading="loading" @choose="handleSelectionChange" @sortChange="sortChange"></my-table>
        </div>
        <div>
          <el-row>
            <el-col :span="12" class="countInfo">
              共计 <span>委案金额</span><span class="money">{{commitMoney}}</span><span>最新欠款金额</span ><span class="money">{{latestDebtMoney}}</span>
            </el-col>
            <el-col :span="12">
              <el-pagination small @current-change="handleCurrentChange" :current-page.sync="conditionForm.currentPage" :page-size="conditionForm.pageSize"
                layout="sizes,total, prev, pager, next,jumper"  @size-change="changeSize"  :page-sizes="[15, 50, 100]" :total="total" >
              </el-pagination>
            </el-col>
          </el-row>
        </div>

      </div>
    </div>

    <!-- 分案结果图 -->
    <div class="content-body pictrue" v-if="pictrueData != null">
      <!-- 顶部，包括标题，操作按钮-->
      <div class="bd-top">
        <div class="md clearfix">
          <!-- 1、左边标题 -->
          <div class="md-left">
            <h5>分案结果</h5>
          </div>
          <!-- 2、右边操作按钮 -->
          <div class="md-right">
          </div>
        </div>
      </div>
      <!-- 结果图标签以及切换 -->
      <div >
        <ul>
          <li>
            <el-button-group>
              <el-button size="mini" @click.native="today" :class="btnClass[0]">今天</el-button>
              <el-button size="mini" @click.native="yesterday" :class="btnClass[1]">昨天</el-button>
              <el-button size="mini" @click.native="lastWeek" :class="btnClass[2]">过去7天</el-button>
              <el-button size="mini" @click.native="lastMonth" :class="btnClass[3]">过去30天</el-button>
            </el-button-group>
          </li>
          <li>
            <el-date-picker size="mini" v-model="chartsDate" start-placeholder="开始日期" end-placeholder="结束日期" type="daterange" @change="chartsDateChange"
              value-format="yyyy-MM-dd" placeholder="选择日期">
            </el-date-picker>
          </li>
        </ul>
      </div>
      <!-- echarts分案图 -->
      <div id="echarts" ></div>
      <p v-if="this.orgId" class="backPrev">
        <span @click="backPrev">
          <el-button size="mini" type="primary">返回</el-button>
        </span>
      </p>
    </div>
    <allotCase :allotShow="allotShow" :selected="chooseAllotData" :departments="departments" @allotClose="allotClose" @refreshList="refreshList"></allotCase>
    <invokCase :invokShow="invokShow" :selected="chooseInvokData" :departments="departments" @invokClose="invokClose" @refreshList="refreshList"></invokCase>
    <!-- <allotCaseGroup :allotGroupShow="allotGroupShow" :conditionForm="conditionForm" :departments="departments" @allotGroupClose="allotGroupClose"
      @refreshList="refreshList"></allotCaseGroup> -->
  </div>
  <div v-else>
    <div class='allotPage'>
      <el-steps  :active="allotProcess" finish-status="success" align-center>
        <el-step title="录入"></el-step>
        <el-step title="确认"></el-step>
        <el-step title="结果"></el-step>
      </el-steps>
    <el-form class="allotForm" v-if="allotProcess==1">
        <el-form-item label="选择部门" prop="aDepartmentIds">
          <el-cascader :options="departments" v-model="aDepartmentIds" @change="handleChange" change-on-select :props="departmentProps"
            size="small"> </el-cascader>
        </el-form-item>
        <el-form-item label="" prop="aStuffId">
          <el-radio v-model="radio" label="1">按委案金额</el-radio>
          <el-radio v-model="radio" label="0">按委案数量</el-radio>
        </el-form-item>
        <el-form-item label="">
          <el-table :data="tableData" style="width: 100%"  v-loading="loading2" element-loading-text="正在进行分配" element-loading-spinner="el-icon-loading">
            <el-table-column prop="worker" label="催收员" align="center" >
            </el-table-column>
            <el-table-column prop="percent" label="比例 "  align="center">
              <template slot-scope="scope">
                <el-input v-model="scope.row.percent"  :maxlength="3" type="tel" class="edit" @blur="checkPercent(scope)" size="mini">
                </el-input>
              </template>
            </el-table-column>

            <el-table-column prop="proportion" label="操作" width="60" align="center">
              <template slot-scope="scope">
                <i class="el-icon-delete" @click="deleteWorker(scope)"></i>
              </template>
            </el-table-column>
            <el-table-column prop="errMsg" label="提示" width="auto"  align="center">
              <template slot-scope="scope">
                <span style="color:#f00" :class="scope.row.errMsg ?errMsg:''" v-if="scope.row.errMsg">{{scope.row.errMsg}}</span>
              </template>
            </el-table-column>

          </el-table>
        </el-form-item>
        <el-form-item style="text-align:right;margin: 20px;">
          <el-button size="small" type="primary" @click.prevent="submitForm">下一步</el-button>
          <el-button size="small" @click.native="cancelForm">取消</el-button>
        </el-form-item>
      </el-form>

  <div  v-else-if="allotProcess==2"  class="allotConfirm">
    <div >
    <!-- <el-form ref="conditionForm" :model="conditionForm" :label-width="this.$util.LABEL_WIDTH" label-position="right" class="condition-form" size="mini">
      <div class="el-col fixed-width" >
        <el-form-item label="部门：" >
          {{allotConfirm.aDepartName}}
        </el-form-item>
        <el-form-item label="分配方式：" >
          {{allotConfirm.allotTypeName}}
        </el-form-item>
      </div>
    </el-form> -->
    <el-row>
      <el-col :span="3" class="head" style="text-align:right">部门：</el-col>
      <el-col :span="6">{{allotConfirm.aDepartName}}</el-col>
      <el-col :span="3" class="head">分配方式：</el-col>
      <el-col :span="6">  {{allotConfirm.allotTypeName}}</el-col>
    </el-row>
    </div>
    <div >
    <h5 >分配结果</h5>
    <div>
      <el-table ref="multipleTable" max-height="500"  :data="allotConfirm.tb.data" tooltip-effect="dark" v-loading="loading" element-loading-text="拼命加载中"
            element-loading-spinner="el-icon-loading" show-overflow-tooltip  >
            <el-table-column v-for="field in allotConfirm.tb.fields" style="cursor:pointer" :align="field.align||'left'"
              :prop="field.key" :label="field.label" :width="field.width" :key="field.key" show-overflow-tooltip>
            </el-table-column>
      </el-table>
      <el-pagination small @current-change="handleCurrentChange2" :current-page.sync="allotConfirm.currentPage" :page-size="allotConfirm.pageSize"
          layout="total, prev, pager, next,jumper" :total="allotConfirm.total" :jumper="10">
        </el-pagination>
      <div style="text-align: right; margin: 20px;">
         <el-button size="small" @click.native="toAllot">上一步</el-button>
         <el-button size="small" type="primary" @click.prevent="toResult">下一步</el-button>
      </div>
    </div>
  </div>
  </div>
  <div class="allotResult" v-else-if="allotProcess ==3">
    <p><span style="color:#99a9bf">处理结果：</span>{{allotResult}}</p>
          <el-button size="small" type="primary" @click.prevent="closeResult">关闭</el-button>
  </div>
  </div>
  </div>
</div>
</template>

<script>
  // import moment from "moment"
  import echarts from 'echarts'
  import qs from "qs";
  import allotCase from './allotCase'
  import invokCase from './invokCase'
  import myTable from '../../public-components/my-table'
 // import data from '../../../mock/mock.js'
  //import allotCaseGroup from './allotCaseGroup'
  const fields =  [
    {
        key: "caseCode",
        label: "案件编号",
        width: "110",
        id: "0",
        type: '0'
      },
      {
        key: "batchCode",
        label: "批次号",
        width: "",
        id: "2",
        type: '0'
      },
      {
        key: "loanInstitution",
        label: "贷款机构",
        width: "auto",
        id: "3",
        type: '0'
      },
      {
        key: "productName",
        label: "产品名称",
        width: "",
        id: "4",
        type: '0'
      },
      {
        key: "borrowerName",
        label: "姓名",
        width: "",
        id: "5",
        type: '0'
      },
      {
        key: "borrowerIdnumber",
        label: "身份证",
        width: "180",
        id: "6",
        type: '0'
      },
      {
        key: "borrowerPhone",
        label: "手机号",
        width: "120",
        id: "7",
        type: '0'
      },
      {
        key: "borrowerAge",
        label: "年龄",
        width: "50",
        id: "9",
        type: '0'
      },
      {
        key: "borrowerGenderName",
        label: "性别",
        width: "50",
        id: "10",
        type: '0'
      },
        {
        key: "commitMoney",
        label: "委案金额",
        width: "120",
        id: "15",
        align: 'right',
        type: '0',
        sortable: 'custom'
      },
      {
        key: "overdueDay",
        label: "逾期天数",
        width: "auto",
        id: "11",
        type: '0'
      },
      {
        key: "receivableAge",
        label: "账龄",
        width: "50",
        id: "12",
        type: '0'
      },
      {
        key: "bacthTimes",
        label: "手别",
        width: "50",
        id: "13",
        type: '0'
      },
      {
        key: "totalDebtMoney",
        label: "欠款金额",
        width: "120",
        id: "14",
        align: 'right',
        type: '0',
        sortable: 'custom'
      },
      
      {
        key: "commitDate",
        label: "委案时间",
        width: "100",
        id: "16",
        type: '0',
        sortable: 'custom'
      },
      {
        key: "limitDate",
        label: "退案时间",
        width: "100",
        id: "18",
        type: '0',
        sortable: 'custom'
      },
      {
        key: "caseArea",
        label: "案件地区",
        width: "",
        id: "19",
        type: '0'
      },
      {
        key: "registeredAddress",
        label: "户籍地",
        width: "",
        id: "20",
        type: '0'
      },
      {
        key: "staffName",
        label: "催收员（ID）",
        width: "100",
        id: "21",
        type: '0'
      },
      {
        key: "departmentName",
        label: "部门",
        width: "auto",
        id: "22",
        type: '0'
      },
      {
        key: "followDate",
        label: "跟进时间",
        width: "100",
        id: "23",
        type: '0',
        sortable: 'custom'
      },
      {
        key: "allotStatusName",
        label: "分配状态",
        width: "auto",
        id: "24",
        type: '0'
      },
      {
        key: "caseStatusName",
        label: "案件状态",
        width: "auto",
        id: "25",
        type: '0'
      },
      {
        key: "collectionStatusName",
        label: "催收状态",
        width: "100",
        id: "26",
        type: '0'
      },
      {
        key: "telStatusName",
        label: "电话状态",
        width: "auto",
        id: "27",
        type: '0'
      }
    ]
  export default {
    components: {
      allotCase,
      invokCase,
      myTable
    //  allotCaseGroup
    },
    data() {
      var validateOverdayMin = (rule, value, callback) => {
          if (value) {
            let pattern = /^[1-9][0-9]{0,5}$/;
            if (!pattern.test(value)) {
              callback(new Error("最多6位整数"));
            } else if (this.conditionForm.overdueDayMax && (this.conditionForm.overdueDayMax - 0 < this.conditionForm.overdueDayMin -
                0)) {
              callback(new Error('最小值不能大于最大值'))
            } else {
              this.$refs['overdueDayMax'].clearValidate()
              callback();
            }
          } else {
            callback();
          }
        },
        validateOverdayMax = (rule, value, callback) => {
          if (value) {
            let pattern = /^[1-9][0-9]{0,5}$/;
            if (!pattern.test(value)) {
              callback(new Error("最多6位整数"));
            } else if (this.conditionForm.overdueDayMin && (this.conditionForm.overdueDayMax - 0 < this.conditionForm.overdueDayMin -
                0)) {
              callback(new Error('最小值不能大于最大值'));
            } else {
              this.$refs['overdueDayMin'].clearValidate();
              callback();
            }
          } else {
            callback();
          }
        },

        validateAgeMin = (rule, value, callback) => {
          if (value) {
            let pattern = /^[1-9][0-9]{0,1}$/;
            if (!pattern.test(value)) {
              callback(new Error("最多2位整数"));
            } else if (this.conditionForm.ageMax && (this.conditionForm.ageMax - 0 < this.conditionForm.ageMin - 0)) {
              callback(new Error('最小值不能大于最大值'));
            } else {
              this.$refs['ageMax'].clearValidate()
              callback();
            }
          } else {
            callback();
          }
        },
        validateAgeMax = (rule, value, callback) => {
          if (value) {
            let pattern = /^[1-9][0-9]{0,1}$/;
            if (!pattern.test(value)) {
              callback(new Error("最多2位整数"));
            } else if (this.conditionForm.ageMin && (this.conditionForm.ageMax - 0 < this.conditionForm.ageMin - 0)) {
              callback(new Error('最小值不能大于最大值'));
            } else {
              this.$refs['ageMin'].clearValidate()
              callback();
            }
          } else {
            callback();
          }
        },
        validateCommitMoneyMin = (rule, value, callback) => {
          if (value) {
            let pattern = /^[1-9][0-9]{0,9}([.][0-9]{0,2})?$/;
            if (!pattern.test(value)) {
              callback(new Error("最多10位整数和2位小数"));
            } else if (this.conditionForm.commitMoneyMax && (this.conditionForm.commitMoneyMax - 0 < this.conditionForm
                .commitMoneyMin - 0)) {
              callback(new Error('最小值不能大于最大值'))
            } else {
              this.$refs['commitMoneyMax'].clearValidate()
              callback();
            }
          } else {
            callback();
          }
        },
        validateCommitMoneyMax = (rule, value, callback) => {
          if (value) {
            let pattern = /^[1-9][0-9]{0,9}([.][0-9]{0,2})?$/;
            if (!pattern.test(value)) {
              callback(new Error("最多10位整数和2位小数"));
            } else if (this.conditionForm.commitMoneyMin && (this.conditionForm.commitMoneyMax - 0 < this.conditionForm
                .commitMoneyMin - 0)) {
              callback(new Error('最小值不能大于最大值'))
            } else {
              this.$refs['commitMoneyMin'].clearValidate()
              callback();
            }
          } else {
            callback();
          }
        }

      return {
        collection_type: "",
        conditionForm: {
          borrowerName: "",
          borrowerIdnumber: "",
          borrowerPhone: "",
          loanInstitution: "",
          productName: "",
          batchCode: "",
          caseCode: "",
          registeredAddress: "",
          caseArea: "",
          borrowerGender: "",
          ageMin: "",
          ageMax: "",
          departmentId: "",
          staffId: "",
          telStatus: "",
          receivableAge: "",
          bacthTimes: "",
          overdueDayMin: "",
          overdueDayMax: "",
          commitMoneyMin: "",
          commitMoneyMax: "",
          debtMoneyMin: "",
          debtMoneyMax: "",
          commitDateMin: "",
          limitDateMin: "",
          commitDateMax: "",
          limitDateMax: "",
          caseStatus: "",
          collectionStatus: "",
          followDateMin: "",
          followDateMax: "",
          allotStatus: "",
          currentPage: 1,
          pageSize: 15,
          CommitDate: [],
          LimitDate: [],
          FollowDate: [],
          sortField: '',
          sequence: ''
        },
        searchForm: {},
        hasSearch: false,
        flag: true,
        dropdownData: {},
        departments: [],
        department: [],
        staffs: [],
        loanInstitution: [],
        tb: {
          data: [],
          fields: fields,
          selectionBtn: true,
          height: 460
        },
        rules: {
          borrowerName: [
            this.$util.formRule.userName
          ],
          borrowerIdnumber: [
            this.$util.formRule.ID
          ],
          borrowerPhone: [
            this.$util.formRule.phone
          ],
          batchCode: [
            this.$util.formRule.batchCode
          ],
          caseCode: [
            this.$util.formRule.caseCode
          ],
          ageMin: [{
            validator: validateAgeMin,
            trigger: "blur",
            type: 'number',
          }],
          ageMax: [{
            validator: validateAgeMax,
            trigger: "blur",
            type: 'number',
          }],
          overdueDayMin: [{
            validator: validateOverdayMin,
            trigger: "blur",
            type: 'number',
          }],
          overdueDayMax: [{
            validator: validateOverdayMax,
            trigger: "blur",
            type: 'number',
          }],
          commitMoneyMin: [{
            validator: validateCommitMoneyMin,
            trigger: "blur",
            type: 'number',
          }],
          commitMoneyMax: [{
            validator: validateCommitMoneyMax,
            trigger: "blur",
            type: 'number',
          }],
          // debtMoneyMin: [{
          //   pattern: /^[1-9][0-9]{0,9}([.][0-9]{0,3})?$/,
          //   message: "最多10位整数和3位小数",
          //   trigger: "blur"
          // }],
          // debtMoneyMax: [{
          //   validator: validateDebtMoney,
          //   trigger: "blur",
          //   type: 'number',
          // }],
          // startRepayMoney: [{
          //   pattern: /^[1-9][0-9]{0,9}([.][0-9]{0,3})?$/,
          //   message: "最多10位整数和3位小数",
          //   trigger: "blur"
          // }],
          // endRepayMoney: [{
          //   validator: validateRepayMoney,
          //   trigger: "blur",
          //   type: 'number',
          // }]
        },
        operationBtns: [],
        chooseAllotData: [],
        chooseInvokData: [],
        selected: [],
        deadCase: [],
        total: 0,
        departmentIds: [],
        departmentId: "",
        departmentProps: {
          label: "name",
          value: "id"
        },
        chartsDate_start: "",
        chartsDate_end: "",
        chartsDate: [],
        pictrueData: [],
        orgId: '',
        btnClass: [
          '',
          '',
          '',
          ''
        ],
        allotShow: false,
        invokShow: false,
        allotGroupShow: false,
        loading: true,
        id: '',
        allotPage: false,
        aDepartmentIds: [],
        aStuffId: '',
        workers: [],
        departmentId2: '',
        hasAbility: false,
        radio: '1',
        hasFault: false,
        errMsg: 'errMsg',
        loading2: false,
        tableData: [
        ],
        rules2: {
          percent: [{
            pattern: /^1[0-9]{0,2}$/,
            message: "格式不正确",
            trigger: "blur",
          }]
        },
        allotStatusName: '',
        aDepartName: '',
        allotResult: '',
        allotConfirm: {
          aDepartName: '',
          allotTypeName: '',
          tb: {
            data: [],
            fields: [
             {
              key: "staffName",
              label: "催收员",
              width: "110",
              id: "0"
            },
             {
              key: "ratio",
              label: "分配比例",
              width: "auto",
              id: "0"
            },
             {
              key: "caseCode",
              label: "案件编号",
              width: "auto",
              id: "0"
            },
             {
              key: "batchCode",
              label: "批次号",
              width: "auto",
              id: "0"
            },
             {
              key: "loanInstitution",
              label: "贷款机构",
              width: "auto",
              id: "0"
            },
             {
              key: "productName",
              label: "贷款产品",
              width: "auto",
              id: "0"
            },
            {
              key: "borrowerName",
              label: "姓名",
              width: "auto",
              id: "0"
            },
            {
              key: "borrowerIdnumber",
              label: "身份证",
              width: "auto",
              id: "0"
            },
            {
              key: "borrowerPhone",
              label: "手机号",
              width: "auto",
              id: "0"
            },
            {
              key: "borrowerAge",
              label: "年龄",
              width: "auto",
              id: "0"
            },
            {
              key: "borrowerGenderName",
              label: "性别",
              width: "auto",
              id: "0"
            },
            {
              key: "commitMoney",
              label: "委案金额",
              width: "auto",
              id: "0"
            },
            {
              key: "overdueDay",
              label: "逾期天数",
              width: "auto",
              id: "0"
            },
            {
              key: "receivableAge",
              label: "账龄",
              width: "auto",
              id: "0"
            },
            {
              key: "bacthTimes",
              label: "手别",
              width: "auto",
              id: "0"
            },
            {
              key: "commitDate",
              label: "委案时间",
              width: "auto",
              id: "0"
            },
            {
              key: "limitDate",
              label: "退案时间",
              width: "auto",
              id: "0"
            },
             {
              key: "caseArea",
              label: "案件地区",
              width: "auto",
              id: "0"
            },
            {
              key: "registeredAddress",
              label: "户籍地",
              width: "auto",
              id: "0"
            },
            {
              key: "caseStatusName",
              label: "案件状态",
              width: "auto",
              id: "0"
            },
            {
              key: "telStatusName",
              label: "电话状态",
              width: "auto",
              id: "0"
            },
            ]
          },
        },
        allotForm: {
          currentPage: 1,
          pageSize: 15,
          total: 0,
        },
        allotProcess: 1,
        commitMoney: '',
        latestDebtMoney: ''
      };
    },
    methods: {
      // 搜搜
      search() {
        this.$refs.conditionForm.validate((valid) => {
          if (valid) {
            this.searchForm = Object.assign({}, this.conditionForm);
            if (this.conditionForm.currentPage == 1) {
              this.getList(this.conditionForm);
              //  this.conditionForm.currentPage = 1;
            } else {
              this.conditionForm.currentPage = 1;
              this.hasSearch = true;
            }
          }
        })
      },
      // 重置
      reset(conditionForm) {
        this.$refs.conditionForm.resetFields();
        this.departmentIds = [];
        this.staffs = []
        this.conditionForm.commitDateMin = '';
        this.conditionForm.commitDateMax = '';
        this.conditionForm.followDateMin = '';
        this.conditionForm.followDateMax = '';
        this.conditionForm.limitDateMin = '';
        this.conditionForm.limitDateMax = '';
        this.searchForm = Object.assign({}, this.conditionForm)
        if (this.conditionForm.currentPage == 1) {
          this.getList(this.conditionForm);
        } else {
          this.conditionForm.currentPage = 1;
          this.hasSearch = true;
        }
      },
      // 选择案件
      handleSelectionChange(data) {
        console.log(data)
        this.chooseAllotData = [];
        this.chooseInvokData = [];
        this.selected = [];
        this.deadCase = [];
        data.forEach((row, index) => {
          if (row.caseStatus == 2 || row.caseStatus == 4 || row.caseStatus == 11) { this.deadCase.push(row.caseId.toString()) } else if (row.allotStatusName ==
            '已分配') {
            this.chooseInvokData.push(row.caseId.toString())
          } else {
            this.chooseAllotData.push(row.caseId.toString())
          }
          this.selected.push(row.caseId.toString())
        })
      },

      // 翻页
      handleCurrentChange(index) {
        this.searchForm.currentPage = index;
        if (this.hasSearch) {
          this.getList(this.conditionForm);
          this.hasSearch = false;
        } else {
          this.conditionForm = Object.assign({}, this.searchForm);
          this.getList(this.searchForm);
        }
      },
      // 翻页2
      handleCurrentChange2(index) {
        this.allotForm.currentPage = index;
        this.$axios
              .post("/api/assignee/caseManage/getAllotCaseConfirm",this.allotForm)
              .then(res => {
                if (res.data.code == 0) {
                  this.$message.success('预分案成功')
                  this.allotConfirm.aDepartName = res.data.data.orgId.name;
                  this.allotConfirm.allotTypeName = res.data.data.allotBy ? '按金额分案':'按委案数量'   
                  this.allotConfirm.tb.data = res.data.data.page.items;
                  this.allotConfirm.total = res.data.data.page.totalNum;
                  this.allotProcess = 2
                } else {
                  this.$util.failCallback(res.data, this);
                } 
                this.loading = false;
              })
              .catch(err => {
                console.log(err);
                this.loading = false;
              });
      },
      //委托时间选择
      commitDate(val) {
        if (val) {
          this.conditionForm.commitDateMin = val[0];
          this.conditionForm.commitDateMax = val[1];
        } else {
          this.conditionForm.commitDateMin = '';
          this.conditionForm.commitDateMax = '';
        }
      },
      //截止时间选择
      limitDate(val) {
        if (val) {
          this.conditionForm.limitDateMin = val[0];
          this.conditionForm.limitDateMax = val[1];
        } else {
          this.conditionForm.limitDateMin = '';
          this.conditionForm.limitDateMax = '';
        }
      },
      //跟进时间
      followDate(val) {
        if (val) {
          this.conditionForm.followDateMin = val[0];
          this.conditionForm.followDateMax = val[1];
        } else {
          this.conditionForm.followDateMin = '';
          this.conditionForm.followDateMax = '';
        }
      },
      // 获取查询列表
      getList(data) {
        var queryParams;
        if (data) {
          queryParams = data
        } else {
          queryParams = this.conditionForm
        }
        this.loading = true;
        this.$axios
          .post("/api/assignee/caseManage/getCaseManageInfoList", queryParams)
          .then(res => {
            if (res.data.code == 0) {
              this.tb.data = res.data.data.items;
              this.total = res.data.data.totalNum;
              this.commitMoney = res.data.data.countInfo ? res.data.data.countInfo.commitMoney : 0;
              this.latestDebtMoney = res.data.data.countInfo ? res.data.data.countInfo.latestDebtMoney : 0
            } else {
              this.$util.failCallback(res.data, this);
            }
            this.loading = false;
          })
          .catch(err => {
            console.log(err);
            this.loading = false;
          });
      },
      // 改变分页size
      changeSize(index) {
        this.conditionForm.pageSize = index;
        this.searchForm.pageSize = index;
        if(this.conditionForm.currentPage == 1) {
          this.getList(this.conditionForm)
        } else {
          this.conditionForm.currentPage = 1;
        }
       },
      // 获取下拉列表数据
      getOptions() {
        this.$axios
          .post("/api/assignee/caseManage/getSearchInfo", {})
          .then(res => {
            if (res.data.code == 0) {
              var data = res.data.data;
              this.dropdownData = res.data.data;
              this.dropdownData.loanInstitution.unshift({
                name: 'All',
                code: ''
              });
              this.dropdownData.allotStatus.unshift({
                name: 'All',
                code: ''
              });
              this.dropdownData.bacthTimes.unshift({
                name: 'All',
                code: ''
              });
              this.dropdownData.caseArea.unshift({
                name: 'All',
                code: ''
              });
              this.dropdownData.caseStatus.unshift({
                name: 'All',
                code: ''
              });
              this.dropdownData.collectionStatus.unshift({
                name: 'All',
                code: ''
              });
              this.dropdownData.gender.unshift({
                name: 'All',
                code: ''
              });
              this.dropdownData.productName.unshift({
                name: 'All',
                code: ''
              });
              this.dropdownData.receivableAge.unshift({
                name: 'All',
                code: ''
              });;
              this.dropdownData.registeredAddress.unshift({
                name: 'All',
                code: ''
              });
              this.dropdownData.telStatus.unshift({
                name: 'All',
                code: ''
              });
              if (this.$route.query.allotStatus) {
                this.conditionForm.allotStatus = this.$util.decrypt(this.$route.query.allotStatus, 'message');

              }
              if (this.$route.query.caseStatus) {

                this.conditionForm.allotStatus = ''
                this.conditionForm.caseStatus = this.$util.decrypt(this.$route.query.caseStatus, 'message');
              }else{
                this.conditionForm.allotStatus = "0";
              }
              this.getList(this.conditionForm);
            } else {
              this.$util.failCallback(res.data, this);
            }
          })
          .catch(err => {
            console.log(err);
          });
      },

      // 获取部门列表
      getApartment() {
        this.$axios
          .post("/api/assignee/caseManage/getDepartmentsCondition", {})
          .then(res => {
            if (res.data.code == 0) {
              this.departments = res.data.data;
            } else {
              this.$util.failCallback(res.data, this);
            }
          })
          .catch(err => {
            console.log(err);
          });
      },

      // 选择部门
      getDepartmentId(currentVal) {
        if (currentVal.length == 0) {
          this.staffs = []
          this.conditionForm.staffId = ''
          this.conditionForm.departmentId = ''
        } else {
          this.conditionForm.departmentId = this.departmentIds[this.departmentIds.length - 1];
          this.$axios
          .post("/api/assignee/caseManage/getStaffs", {
            departmentId: this.conditionForm.departmentId
          })
          .then(res => {
            if (res.data.code == 0) {
              this.staffs = res.data.data;
            } else {
              this.$util.failCallback(res.data, this);
            }
          })
          .catch(err => {
            console.log(err);
          });
        }
        
      },

      // 画出分案结果图
      drawChat() {
        var pictrueData = this.pictrueData;
        var companyName = [],
          caseCount = [],
          caseMoney = [],
          ids = [],
          flag = [];
        var len = pictrueData.length;
        while (len--) {
          companyName.push(pictrueData[len]['name']);
          caseCount.push(pictrueData[len]['caseCount']);
          caseMoney.push(pictrueData[len]['caseMoney']);
          ids.push(pictrueData[len]['id']);
          flag.push(pictrueData[len]['flag'])
        }
        var option = {
          tooltip: {
            trigger: "axis",
            axisPointer: {
              type: "cross",
              label: {
                backgroundColor: "#283b56"
              }
            }
          },
          title: {

          },
          legend: {
            data: ["案件金额", "案件数量"]
          },
          toolbox: {
            show: false,
          },
          dataZoom: {
            show: false,
            start: 0,
            end: 100
          },
          xAxis: [{
            type: "category",
            boundaryGap: true,
            data: companyName,
            axisLabel: {
              interval: 0,
              rotate: 45,
              margin: 10,
            }
          }, ],
          yAxis: [{
              type: "value",
              scale: true,
              name: "案件金额（万元）",
              min: 0,
              splitLine: {
                show: false
              }
            },
            {
              type: "value",
              scale: true,
              name: "案件数量",
              min: 0,
              splitLine: {
                show: false
              }
            }
          ],

          series: [{
              name: "案件金额",
              type: "bar",
              barMaxWidth:100,
              data: caseMoney,
              itemStyle: {
                normal: {
                  color: '#66A3FC'
                }
              },
            },
            {
              name: "案件数量",
              type: "line",
              data: caseCount,
              yAxisIndex: 1,
            }
          ],
          grid: {
            left: '40px',
            right: '20px',
            bottom: '60px',
            containLabel: true
          },
        };
        var chart = document.getElementById('echarts');
        chart.removeAttribute("_echarts_instance_");
        var myChart = echarts.init(chart);
        myChart.setOption(option);
        var _this = this;
        myChart.on('click', function (params) {
        //  console.log(params);
          if (params) {
            var index = params.dataIndex;
            if (ids[index]) {
              _this.id = this.orgId;
              _this.orgId = ids[index];
              _this.flag = flag[index];
              if(!_this.flag) {
                return false
              }
              _this.getPictrueData();
            }
          }
        });
      },

      // 获取分案结果图的数据
      getPictrueData() {
        var url = this.orgId ? "api/assignee/caseManage/getAnalysisDataDetails" :
          "/api/assignee/caseManage/getAnalysisData"
        this.$axios
          .post(
            url,
            JSON.parse(
              JSON.stringify({
                dateMin: this.chartsDate_start,
                dateMax: this.chartsDate_end,
                departmentId: this.orgId,
                flag: this.flag
              })
            )
          )
          .then(res => {
            if (res.data.code == 0) {
              this.pictrueData = res.data.data;
              this.drawChat();
            } else {
              this.$util.failCallback(res.data, this);
            }
          })
          .catch(err => {
            console.log(err);
          });
      },

      // 切换分案结果：今天
      today() {
        if (this.btnClass[0]) {
          return false
        } else {
          this.btnClass = ['el-button--primary', '', '', '']
        }
        this.chartsDate_start = moment().format("YYYY-MM-DD")
        this.chartsDate_end = moment().format("YYYY-MM-DD");
        this.chartsDate = [];
        this.getPictrueData();
      },

      // 切换分案结果：昨天
      yesterday() {
        if (this.btnClass[1]) {
          return false
        } else {
          this.btnClass = ['', 'el-button--primary', '', '']
        }
        this.chartsDate_start = moment().subtract(1, 'days').format("YYYY-MM-DD")
        this.chartsDate_end = moment().subtract(1, 'days').format("YYYY-MM-DD");
        this.chartsDate = [];
        this.getPictrueData();
      },

      // 切换分案结果：过去七天
      lastWeek() {
        if (this.btnClass[2]) {
          return false
        } else {
          this.btnClass = ['', '', 'el-button--primary', '']
        }
        this.chartsDate_start = moment().subtract(7, 'days').format("YYYY-MM-DD")
        this.chartsDate_end = moment().subtract(1, 'days').format("YYYY-MM-DD");
        this.chartsDate = [];
        this.getPictrueData();
      },

      // 切换分案结果：过去三十天
      lastMonth() {
        if (this.btnClass[3]) {
          return false
        } else {
          this.btnClass = ['', '', '', 'el-button--primary']
        }
        this.chartsDate_start = moment().subtract(30, 'days').format("YYYY-MM-DD")
        this.chartsDate_end = moment().subtract(1, 'days').format("YYYY-MM-DD");
        this.chartsDate = [];
        this.getPictrueData();
      },

      // 切换时间选择器
      chartsDateChange(data) {
        this.btnClass = ['', '', '', ''];
        this.chartsDate_start = data[0]
        this.chartsDate_end = data[1]
        this.getPictrueData();
      },

      // 人工分案
      allotCase() {
        if (!this.selected.length) {
          this.$alert("请选择案件！", "提示", {
            confirmButtonText: "确定",
            type: 'warning'
          });
          return false;
        } else if (this.chooseInvokData.length ) {
          this.$alert("含有已分案或已结案案件，请重新选择 ", "提示", {
            confirmButtonText: "确定",
            type: 'warning'
          });
          return false;
        } else if(this.deadCase.length) {
           this.$alert("含有已撤案，已还款或已过期案件，请重新选择 ", "提示", {
            confirmButtonText: "确定",
            type: 'warning'
          });
          return false;
        }
        this.allotShow = true;
      },

      // 人工调案
      invokCase() {
        if (!this.chooseInvokData.length) {
          this.$alert("请至少选择一笔已分配案件！", "提示", {
            confirmButtonText: "确定",
            type: 'warning'
          });
          return false;
        } else if (this.chooseAllotData.length) {
          this.$alert("含有未分案或已结案案件，请重新选择 ", "提示", {
            confirmButtonText: "确定",
            type: 'warning'
          });
          return false;
        }else if(this.deadCase.length) {
           this.$alert("含有已撤案，已还款或已过期案件，请重新选择 ", "提示", {
            confirmButtonText: "确定",
            type: 'warning'
          });
          return false;
        }
        this.invokShow = true;
      },

      // 人工批次分案
      allotGroupCase() {
        if (this.conditionForm.allotStatus != '0') {
          this.$alert("仅可对待分配案件批量分案，请重新操作！", "提示", {
            confirmButtonText: "确定",
            type: 'warning'
          });
          return false;
        }
        if (this.selected.length) {
          this.$alert("该项操作无需选择案件！", "提示", {
            confirmButtonText: "确定",
            type: 'warning'
          });
          return false;
        }
        if (this.tb.data.length == 0) {
           this.$alert("无搜索案件，请重新搜索", "提示", {
            confirmButtonText: "确定",
            type: 'warning'
          });
          return false;         
        }
        this.allotPage = true;
        this.allotProcess = 1;
      },

      // 人工分案关闭
      allotClose() {
        this.allotShow = false;
      },

      // 人工调案关闭
      invokClose() {
        this.invokShow = false;
      },

      // 批次分案关闭
      allotGroupClose() {
        this.allotGroupShow = false;
      },
      // echarts图回退
      backPrev() {
        this.orgId = '';
        this.getPictrueData();
      },
      // 调案和分案成功后刷新列表
      refreshList() {
        this.getList(this.conditionForm);
      },

      redirect(row, column, cell, event) {
        if (column.label == "案件数量") {
          this.$router.push({
            path: '/case_detail/' + row.batchId
          })
        }
      },
       // 选择部门
      handleChange(data) {
        if(!data) {return false;}
        this.aStuffId = '';
        this.departmentId = this.aDepartmentIds[this.aDepartmentIds.length - 1];
        this.checkDepartment();
      },
            // 提交表单
      submitForm() {
        let arr = [];
        let total = 0;
        if (this.departmentId) {
          if (this.tableData.length > 0) {
            var err = document.getElementsByClassName('errMsg');
            if (err.length > 0) {
              return false;
            }
            for (var item of this.tableData) {
              arr.push({
                ratio: item.percent,
                staffId: item.id
              });
              total += Number(item.percent);
            };
            if(total != 100) {
              this.$alert("分配比例总和不为100%！", "提示", {
              confirmButtonText: "确定",
              type: 'warning'
            });
            return false;
            }
            this.allotForm = Object.assign(this.allotForm,this.conditionForm)
            this.allotForm.allotBy = this.radio;
            this.allotForm.allotInfos = arr;
            this.allotForm.orgId = this.departmentId;
            this.loading2 = true;
            this.$axios
              .post("/api/assignee/caseManage/getAllotCaseConfirm",this.allotForm)
              .then(res => {
                if (res.data.code == 0) {
                  this.$message.success('预分案成功')
                  this.allotConfirm.aDepartName = res.data.data.orgId.name;
                  this.allotConfirm.allotTypeName = res.data.data.allotBy ? '按金额分案':'按委案数量' ;
                  this.allotConfirm.tb.data = res.data.data.page.items;
                  this.allotConfirm.total = res.data.data.page.totalNum;
                  this.allotProcess = 2
                } else {
                  this.$util.failCallback(res.data, this);
                }
                this.loading2 = false;
              })
              .catch(err => {
                console.log(err);
                this.loading2 = false;
              });

          } else {
            this.$alert("未选择催收员！", "提示", {
              confirmButtonText: "确定",
              type: 'warning'
            });
            return false;
          }
        } else {
          this.$alert("未选择部门！", "提示", {
            confirmButtonText: "确定",
            type: 'warning'
          });
          return false;
        }
      },
      getPreData() {
        this.$axios
          .post("/api/assignee/caseManage/getAllotCaseConfirmPage", {
            allotBy: this.conditionForm.radio,
            currentPage: this.allotConfirm.currentPage,
            orgId: this.conditionForm.orgId ,
            pageSize: this.allotConfirm.pageSize
          })
          .then(res => {
            if (res.data.code == 0) {
               this.allotConfirm.aDepartName = res.data.data.orgId.name;
               this.allotConfirm.allotTypeName = res.data.data.allotBy ? '按委案数量':'按金额分案'   
               this.allotConfirm.tb.data = res.data.data.items;
               this.allotConfirm.total = res.data.data.totalNum
            } else {
              this.$util.failCallback(res.data, this);
            }
          })
          .catch(err => {
            console.log(err);
          });
      },
       // 获取所选部门的催收员
      getWorkers() {
        this.$axios
          .post("/api/assignee/caseManage/getStaffs", {
            departmentId: this.departmentId
          })
          .then(res => {
            if (res.data.code == 0) {
              this.tableData = [];
              this.workers = res.data.data;
              for (var item of this.workers) {
                this.tableData.push({
                  worker: item.name,
                  id: item.id,
                  percent: '0',
                  errMsg: ''
                })
              }
            } else {
              this.$util.failCallback(res.data, this);
            }
          })
          .catch(err => {
            console.log(err);
          });
      },
       // 检查部门组长是否有权限 /assignee/caseManage/checkDepartment
      checkDepartment() {
        this.$axios
          .post("/api/assignee/caseManage/checkDepartmentByBatch", {
            departmentId: this.departmentId
          })
          .then(res => {
            if (res.data.code == 0) {
         //     console.log(res.data.code, 234)
              this.hasAbility = res.data.code ? true : false;
              if (!this.hasAbility) {
                this.getWorkers();
              }
            } else {
              this.$util.failCallback(res.data, this);
            }
          })
          .catch(err => {
            console.log(err);
          });
      },
        // 人工分案
      allotChooseCase() {
        this.$axios
          .post("/api/assignee/caseManage/allotCase", JSON.parse(JSON.stringify({
            departmentId: this.departmentId,
            caseIds: this.selected,
            isRight: this.hasAbility - 0,
            staffId: this.aStuffId
          })))
          .then(res => {
            if (res.data.code == 0) {
              this.$message.success('分案成功');
              this.$emit('refreshList')
            } else {
              this.$util.failCallback(res.data, this);
            }
          })
          .catch(err => {
            console.log(err);
          });
      },

      // 检查分配比例 
      checkPercent(scope) {
        let row = scope.row;
        row.errMsg = ''
        if (row.percent <= 100 && row.percent >= 0) {
          let total = 0;
          
          for (var item of this.tableData) {
            total += Number(item.percent);
          }
          if (scope.$index == this.tableData.length - 2) {
            let rest = 100 - total + Number(this.tableData[this.tableData.length - 1].percent) ;
            if (this.tableData[this.tableData.length - 1].percent >= 0 && rest >= 0) {
              this.tableData[this.tableData.length - 1].percent = rest.toFixed(0)
            }
          }
           else if (total > 100) {
            row.errMsg = '分配比例和已经大于100%';
            console.log(total)
          }
        
        } else {
          row.errMsg = "比例在0和100之间";
          this.hasFault = true;
        }
      },
      // 删除催收员
      deleteWorker(scope) {
        this.tableData.splice(scope.$index, 1)
      },
      // 停止催收
      cancelForm() {
        this.aDepartmentIds = [];
        this.tableData = [];
        this.radio = '1';
        this.allotPage = false;
      },
      // 下一步到结果
      toResult() {
        this.$axios
          .post("/api/assignee/caseManage/batchAllotCase", {
             allotBy: this.allotForm.radio,
             orgId: this.allotForm.orgId
          })
          .then(res => {
            if (res.data.code == 0) {
              this.allotResult = '已分配'
              this.$message.success('分案成功');
            } else {
              //this.$util.failCallback(res.data, this);
              this.allotResult = res.data.msg;
            }
          })
          .catch(err => {
            console.log(err);
          });
       this.allotProcess = 3
      },
      // 上一步到开始
      toAllot() {
        this.allotProcess = 1
      },
      // 关闭批次分案页面
      closeResult() {
        this.aDepartmentIds = [];
        this.tableData = [];
        this.radio = '1';
        this.allotPage = false;
        this.getList();
      },
      sortChange(item) {
        this.conditionForm.sortField = item.prop;
        this.conditionForm.sequence = item.order === 'ascending'?'ASC':'DESC';
        this.conditionForm.currentPage == 1;
        this.getList(this.conditionForm);
      }
    },
    created() {
      
      this.getOptions();
      this.getApartment(); 
      this.searchForm = Object.assign({}, this.conditionForm);
      this.today();
    }

  };

</script>

<style lang="scss" scoped>
  .dialogInput .el-input {
    width: auto
  }

  .input-with-select .el-input-group__prepend {
    background-color: #fff;
  }



  .el-input__icon {
    text-align: right;
  }

  .pictrue {
    margin: 20px 0;
    padding: 0;
    font-size: 16px; // border-bottom: 2px solid #bbbbbb;
    // border-left: 2px solid #bbbbbb;
    // border-right: 2px solid #bbbbbb;
    .charts-date {
      text-align: center;
      font-size: 14px;
      line-height: 30px;
      margin: 10px 0 0 0;
      .el-input__inner {
        width: 160px;
      }
    }
    ul {
      margin: 10px 0 0 0;
      li {
        display: inline-block;
        margin-left: 10px;
      }
    }
    #echarts {
      width: 100%;
      height: 400px;
      margin-top: 20px;
    }
  } // .el-dialog__title {
  //   font-size: 20px;
  //   color: #444;
  // }
  .el-date-editor--datetimerange.el-input,
  .el-date-editor--datetimerange.el-input__inner {
    width: 100%
  } // 错误提示
  .el-form-item__error {
    min-width: 150px;
    background: #fff;
  }


  .edit .el-input__inner {
    width:80%!important;
    display: inline;
  }

  .backPrev {
    position: relative;
    top: -405px;
    font-size: 12px;
    color: #333;
    margin-left: 20px;
    background: none;
    text-align: left;
    cursor: pointer;
    &:hover {
      color: #F09B10
    }
  }
  .allotPage {
    margin-top:50px;
    .el-steps {
      margin:40px auto 20px;
    }
  }
  .allotForm,.allotConfirm,.allotResult {
    width:70%;
    margin:0 auto;
    h5 {
      clear:both;
      margin:20px 0 5px;
      color:#909399

    }  
  }
  .allotResult {
    text-align: center;
    .el-button {
      margin:20px;
    }
  }
    .el-dialog .el-form {
    width: 70%;
    margin: 0 auto;
  }

  .el-select .el-input {
    width: 100%;
  }

  .el-form-item:last-child {
    text-align: right;
  }

  // .el-table th>.cell,
  // .el-table .cell {
  //   text-align: center;
  // }

  .edit::after {
    content: " %";
    display: inline;
  }

  .edit .el-input__inner {
    width: 60px!important;
  }

  .errMsg {
    color: #f56c6c;
  }

  .el-icon-delete {
    cursor: pointer;
    &:hover {
      color: #f56c6c
    }
  }
  .allotConfirm {
    font-size:14px;
    .head {
      color:#909399;
      width:70px;
      text-align: left;

    }
  }

</style>
